name: Smoke Test

on:
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Ingest (Smoke)
        env:
          SMOKE_TEST: "true"
        run: python scripts/ingest_pubmed.py

      - name: Run Extract (Smoke)
        env:
          SMOKE_TEST: "true"
        run: python scripts/extract_claims.py

      - name: Run Drive Sync
        if: always()
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$SERVICE_ACCOUNT_JSON" ]; then
            echo "$SERVICE_ACCOUNT_JSON" > service_account.json
          fi
          # Run sync, allowing failure if no creds, but capturing output
          python scripts/sync_to_drive.py || echo "Sync failed as expected (no creds)"

      - name: Verify Status File
        if: always()
        run: |
          if [ ! -f 00_ADMIN/pipeline_status.json ]; then
            echo "Error: Pipeline status file missing!"
            exit 1
          fi
          echo "Pipeline status file found:"
          cat 00_ADMIN/pipeline_status.json
