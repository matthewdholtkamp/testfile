name: Daily Full-Text Drop

on:
  schedule:
    - cron: '0 13 * * *' # 13:00 UTC (07:00 CST), runs after Daily Backfill (12:00 UTC)
  workflow_dispatch:

jobs:
  daily-drop:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib requests

    - name: Download Backfill Artifacts
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: daily_backfill.yml
        workflow_conclusion: success
        name: daily-backfill-outputs
        path: backfill_artifacts

    - name: Locate and Verify ALLXML
      id: setup-inputs
      run: |
        echo "Searching for ALLXML file..."
        # Find the file, taking the first match if multiple (should be only one per run)
        ALLXML_FILE=$(find backfill_artifacts -name "ALLXML_*.xml" | head -n 1)

        if [ -z "$ALLXML_FILE" ]; then
          echo "::error::No ALLXML file found in artifacts!"
          exit 1
        fi

        echo "Found: $ALLXML_FILE"

        # Parse Date from Filename: ALLXML_YYYYMMDD.xml
        BASENAME=$(basename "$ALLXML_FILE")
        # Remove prefix "ALLXML_"
        DATE_PART=${BASENAME#ALLXML_}
        # Remove suffix ".xml"
        DATE_PART=${DATE_PART%.xml}

        # Extract YYYY, MM, DD
        YYYY=${DATE_PART:0:4}
        MM=${DATE_PART:4:2}
        DD=${DATE_PART:6:2}
        FILE_DATE="$YYYY-$MM-$DD"

        TODAY=$(date -u +"%Y-%m-%d")

        echo "Artifact Date: $FILE_DATE"
        echo "Today's Date:  $TODAY"

        # Fail fast if the artifact is stale
        if [ "$FILE_DATE" != "$TODAY" ]; then
          echo "::error::Artifact date ($FILE_DATE) does not match today ($TODAY). The daily backfill may have failed or hasn't run yet."
          exit 1
        fi

        # Export variables for next step
        echo "allxml_path=$ALLXML_FILE" >> $GITHUB_OUTPUT
        echo "date=$FILE_DATE" >> $GITHUB_OUTPUT

    - name: Write OAuth token.json
      shell: bash
      run: |
        cat > token.json <<'JSON'
        ${{ secrets.GOOGLE_TOKEN_JSON }}
        JSON
        chmod 600 token.json

    - name: Run Drop Script
      env:
        DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
      run: |
        python scripts/push_daily_fulltext_drop.py \
          --date "${{ steps.setup-inputs.outputs.date }}" \
          --allxml "${{ steps.setup-inputs.outputs.allxml_path }}"

    - name: Cleanup token
      if: always()
      run: rm -f token.json || true
